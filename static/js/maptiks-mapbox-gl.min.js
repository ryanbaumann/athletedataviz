!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e():"function"==typeof define&&define.amd?define(e):e()}(0,function(){"use strict";function t(t){function e(t){throw new Error(t+" must be defined")}var r=t.id,o=t.library,n=t.map,i=t.session,a=t.trackcode,s=t.debug,p=t.test,c=t.standalone,u=t.getMapState,l=/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[0-9a-f]{4}-[0-9a-f]{12}$/,_=i.match(l),m=a.match(l);if(r?this._id=r.toString():e("Maptiks ID"),"mapboxgl"!==o&&"leaflet"!==o&&"gmaps"!==o&&"ol"!==o&&"esri3"!==o)throw new Error("Library must defined as mapboxgl, leaflet, gmaps, ol, or esri3");if(this._library=o,n){if("object"!=typeof n)throw new Error("Map must be an object");this._map=n}else e("Map");if("string"==typeof i&&""!==i){if(!_)throw new Error("Session must be a v4 UUID");this._session=i}else e("Session");if("string"==typeof a&&""!==a){if(!m)throw new Error("Trackcode not valid");this._trackcode=a}else e("Trackcode");if(s){if("boolean"!=typeof s)throw new Error("Debug must be true or false");this._debug=s}else this._debug=!1;if(p){if("boolean"!=typeof p)throw new Error("Test must be true or false");this._test=p}else this._test=!1;if(c){if("boolean"!=typeof c)throw new Error("Standalone must be true or false");this._standalone=c}else this._standalone=!1;if(u){if("function"!=typeof u)throw new Error("getMapState must be a function");this.getMapState=u}else e("getMapState")}function e(t,e){for(var r in t)t.hasOwnProperty(r)&&"prototype"!==r&&!e[r]&&(e[r]=t[r]);return e}function r(t){var e={},r={action:"act",category:"cat",clickable:"clck",draggable:"drag",group:"grp",href:"href",id:"id",initial:"init",internal:"intr",label:"lbl",map_bbox:"bbox",map_center:"cp",map_id:"mid",map_library:"lib",map_session:"msid",map_srs:"srs",map_srs_type:"srst",map_trackcode:"tid",map_zoom:"zm",position:"pos",session:"lsid",tile_center:"tcp",tile_url:"turl",timestamp:"t",url:"url",value:"vle"};for(var o in t)t.hasOwnProperty(o)&&r.hasOwnProperty(o)?e[r[o]]=t[o]:e[o]=t[o];return e}function o(t,e){return t.replace(/\{ *([\w_]+) *\}/g,function(t,r){var o=e[r];if(void 0===o)throw new Error("No value provided for variable "+t);return"function"==typeof o&&(o=o(e)),o})}function n(t){return t._timer=t._timer||{},t._timer.stop=function(){var e=(new Date).getTime(),r=e-this._startTime;return delete t._timer,r},t._timer._startTime=(new Date).getTime(),t}function i(){var t=(new Date).getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var r=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?r:7&r|8).toString(16)})}function a(t,e){return-1===t.indexOf(e)&&(t.push(e),!0)}function s(t,e){return-1!==t.indexOf(e)&&(t.splice(t.indexOf(e),1),!0)}function p(){}function c(){}function u(){}function l(){}function _(){}function m(){}function f(){}function d(t){var e=t.split("?")[0].toLowerCase();return e=e.match(/(?:(?:\/#!?\/)?(?:[^#]+))/),e=e[0].replace(/(^\/(?:#!?\/)?)?((?:\/(?:index|default)\.[a-z]{3,4})?\/?$)?(\/$)?/g,"")}function h(t,e,r){var o=null;return e=e||",",r=r||e,o=t.split(e),o.sort().toString().replace(/,/g,r)}function k(t,e){return(null===e||void 0===e||e<0)&&(e=5),Number(t.toFixed(e))}function y(){var t=this._map.getCenter(),e=this._map.getBounds(),r=e.getNorthEast(),o=e.getSouthWest(),n=k,i=parseFloat(this._map.getBearing().toFixed(1)),a=parseFloat(this._map.getPitch().toFixed(1));return{bbox:[n(o.lng),n(o.lat),n(r.lng),n(r.lat)],center:[n(t.lng),n(t.lat)],zoom:n(this._map.getZoom()),bearing:i,pitch:a}}function g(){E._initialTimeout=100,E._initialTime=(new Date).getTime(),E._zoom=E.getMapState().zoom,E.trackMapSession(),E._map.on("moveend",function(){E.trackPanZoom()}),E._map.on("style.load",function(t){if(t.style&&t.style.stylesheet&&t.style.stylesheet.sources){var e=Object.keys(t.style.stylesheet.sources)[0];e&&(E._layers.slice(0).reverse().map(function(t){return E.trackLayerRemove(t.windowMaptiks)}),t.style.sourceCaches[e].eventType=t.type,v(t.style.sourceCaches[e]))}}),E._map.on("addLayer",function(t){t.sourceCache&&(t.sourceCache.eventType=t.type,v(t.sourceCache))}),E._map.on("removeLayer",function(t){if(t.sourceId){var e=E._layers.findIndex(function(e){return e.id===t.sourceId});-1!==e&&E.trackLayerRemove(E._layers[e].windowMaptiks)}}),E._map.on("addMarker",function(t){t.marker&&w(t)}),E._map.on("addPopup",function(t){t.popup&&x(t)}),E._map.on("error",function(t){if(t.sourceId&&t.tile&&"errored"===t.tile.state){var e=E._layers.findIndex(function(e){return e.id===t.sourceId});if(-1!==e){var r=t.tile.tileID.canonical.x,o=t.tile.tileID.canonical.y,n=E._layers[e].windowMaptiks;E.trackTileError(n,[r,o],n._url)}}})}function v(t){t.windowMaptiks=t.windowMaptiks||{};var e=t.windowMaptiks;_.mixin(e),e._layer=t,e._map=t.map,"style.load"===t.eventType&&t.style.stylesheet.owner&&t.style.stylesheet.id?e._url="mapbox://styles/"+t.style.stylesheet.owner+"/"+t.style.stylesheet.id:"geojson"===t._source.type?e._url="local geojson":"raster"===t._source.type?e._url=t._source._options.tiles[0]:e._url="unknown",e._id=t._source._options.maptiks_id||e._url,E.trackLayerAdd(e),E._map.on("load",function(){E.trackLayerLoad(e)})}function b(t){var e=k;t._position=[e(t._marker.getLngLat().lng),e(t._marker.getLngLat().lat)]}function w(t){t.marker.windowMaptiks=t.marker.windowMaptiks||{};var e=t.marker.windowMaptiks,r=k;m.mixin(e),e._clickable=!1,e._draggable=t.marker._draggable||!1,e._group=t.marker._element.tagName.toLowerCase()+"."+h(t.marker._element.className," ","."),e._map=t.target,e._marker=t.marker,e._popup=t.marker._popup||null,e._position=[r(t.marker.getLngLat().lng),r(t.marker.getLngLat().lat)],e._id=e._position,e._popup&&(e._clickable=!0),E.trackMarkerAdd(e),t.marker.on("click",function(){E.trackMarkerClick(e)}),t.marker.on("drag",function(){b(e)}),t.marker.on("dragend",function(){b(e),E.trackMarkerMove(e)}),t.marker.on("removeMarker",function(){E.trackMarkerRemove(e)})}function x(t){t.popup.windowMaptiks=t.popup.windowMaptiks||{};var e=t.popup.windowMaptiks,r=k;f.mixin(e),e._content=t.popup._content.textContent,e._map=t.target,e._marker=null,e._popup=t.popup,e._position=[r(t.popup.getLngLat().lng),r(t.popup.getLngLat().lat)],e._id=e._position,E.trackPopupAdd(e),t.popup.on("removePopup",function(){E.trackPopupRemove(e)}),window.addEventListener&&e._popup._content?e._popup._content.addEventListener("click",function t(){document.activeElement.href&&(e._popup._content.removeEventListener("click",t),E.trackPopupNavigate(e,document.activeElement.href))}):window.attachEvent&&e._popup._content&&e._popup._content.attachEvent("onclick",function t(){document.activeElement.href&&(e._popup._content.detachEvent("onclick",t),E.trackPopupNavigate(e,document.activeElement.href))})}window.maptiks=window.maptiks||{},window.maptiks.version="2019-04-03",function(){Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){var r=null;if(null===this||void 0===this)throw new TypeError('"this" is null or not defined');var o=Object(this),n=o.length>>>0;if(0===n)return-1;var i=Number(e)||0;if(Math.abs(i)===1/0&&(i=0),i>=n)return-1;for(r=Math.max(i>=0?i:n-Math.abs(i),0);r<n;){if(r in o&&o[r]===t)return r;r+=1}return-1})}(),t.mixin=function(r){e(t.prototype,r)};var M={},L=[];t.prototype={_subdomain_index:0,_hb_timeout_id:null,_getServerUrl:function(t){var e="heartbeat"===t?"https://{s}-catcher.maptiks.com/store/hb.gif":"https://{s}-catcher.maptiks.com/store/a.gif",r=["a","b","c","d"];this._subdomain_index>=r.length&&(this._subdomain_index=0);var n=o(e,{s:r[this._subdomain_index]});return this._subdomain_index+=1,n},getId:function(){return this._id},getLibrary:function(){return this._library},getMapState:function(){throw new Error("getMapState has not been overriden with map library")},getSession:function(){return this._session},getTrackcode:function(){return this._trackcode},on:function(t,e,r){(M[t]=M[t]||[]).push([e,r])},off:function(t,e){for(var r=t||(M={}),o=M[r]||L,n=o.length=e?o.length:0;n--;)o.splice(n,1)},emit:function(t){for(var e=M[t]||L,r=e.length>0?e.slice(0,e.length):e,o=0;o<r.length;o++)r[o][0].apply(r[o][1],L.slice.call(arguments,1))},track:function(t){clearTimeout(this._hb_timeout_id);var e=[],o=new Image,n=this.getMapState();if("object"!=typeof t||t==={})return null;t.map_id=this.getId(),t.map_library=this.getLibrary(),t.map_session=this.getSession(),t.map_trackcode=this.getTrackcode(),t.map_bbox=n.bbox,t.map_center=n.center,t.map_zoom=n.zoom,t.map_srs=n.srs,t.map_srs_type=n.srs_type,t.timestamp=parseFloat((new Date).getTime())+Math.random();var i=604800;"heartbeat"===t.action&&(i=300),t.expires_at=t.timestamp/1e3+i;var a=r(t);if(console&&this._debug)console.log(a);else if(console&&this._test)for(var s=Object.keys(a).sort(),p=0;p<s.length;p++)console.log(p,s[p],a[s[p]]);else{for(var c in a)a.hasOwnProperty(c)&&Boolean(void 0!==a[c])&&Boolean(null!==a[c])&&e.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));o.src=this._getServerUrl(t.action)+"?"+e.join("&"),this.emit("maptiks:track",t),this._hb_timeout_id=setTimeout(function(){this.track({category:"map",action:"heartbeat"})}.bind(this),6e4)}return a}},p.mixin=function(t){e(p.prototype,t)},p.prototype={_layers:null,_trackLayer:function(t,e){this._standalone||this.track({category:e.category,action:e.action,label:e.label,value:e.value,id:t.getId(),session:t.getSession(),url:t.getUrl(),tile_center:e.tile_center,tile_url:e.tile_url,internal:!0})},getLayers:function(){return this._layers},trackLayerAdd:function(t){t._session=i(),t=n(t),a(this._layers,t._layer),t._source&&t._source.maptiks&&a(t._source.maptiks._layers,t._layer),this._trackLayer(t,{category:"layersession",action:"statechange",label:"active"})},trackLayerRemove:function(t){this._trackLayer(t,{category:"layersession",action:"statechange",label:"inactive"}),t._session=null,s(this._layers,t._layer),t._source&&t._source.maptiks&&s(t._source.maptiks._layers,t._layer)},trackLayerLoad:function(t){t._timer&&t.getSession()&&this._trackLayer(t,{category:"tlayer",action:"layerload",value:t._timer.stop()})},trackTileError:function(t,e,r){this._trackLayer(t,{category:"tlayer",action:"tileerror",tile_center:e,tile_url:r})}},c.mixin=function(t){e(c.prototype,t)},c.prototype={_mapSessionTracked:null,getMap:function(){return this._map},_trackMap:function(t){this._standalone||this.track({category:t.category,action:t.action,label:t.label,internal:!0})},trackMapSession:function(){this._mapSessionTracked||(this._mapSessionTracked=!0,this._trackMap({category:"map",action:"mapload",label:"mapsession"}))},trackPanZoom:function(){this.getMapState().zoom===this._zoom?this._trackMap({category:"map",action:"mapactivity",label:"pan"}):this._zoom&&this._trackMap({category:"map",action:"mapactivity",label:"zoom"}),this._zoom=this.getMapState().zoom}},u.mixin=function(t){e(u.prototype,t)},u.prototype={_markers:null,_trackMarker:function(t,e){this._standalone||this.track({category:"marker",action:e.action,value:e.value,id:t.getId(),group:t.getGroup(),position:t.getPosition(),clickable:t.isClickable(),draggable:t.isDraggable(),map_srs:t.srs,map_srs_type:t.srs_type,internal:!0})},getMarkers:function(){return this._markers},trackMarkerAdd:function(t){t=n(t),a(this._markers,t._marker)},trackMarkerClick:function(t){this._trackMarker(t,{action:"click"})},trackMarkerMove:function(t){this._trackMarker(t,{action:"move"})},trackMarkerRemove:function(t){s(this._markers,t._marker)}},l.mixin=function(t){e(l.prototype,t)},l.prototype={_popups:null,_trackPopup:function(t,e){this._standalone||this.track({category:"popup",action:e.action,value:e.value,href:e.href,id:t.getId(),position:t.getPosition(),internal:!0})},getPopups:function(){return this._popups},trackPopupAdd:function(t){t=n(t),a(this._popups,t._popup),this._trackPopup(t,{action:"add"})},trackPopupRemove:function(t){s(this._popups,t._popup),t._timer&&this._trackPopup(t,{action:"remove",value:t._timer.stop()})},trackPopupNavigate:function(t,e){t._timer&&(this._trackPopup(t,{action:"navigate",value:t._timer.stop(),href:e}),t=n(t))}},_.mixin=function(t){e(_.prototype,t)},_.prototype={_layer:null,_map:null,_id:null,_session:null,_url:null,getId:function(){return this._id},getLayer:function(){return this._layer},getMap:function(){return this._map},getSession:function(){return this._session},getUrl:function(){return this._url}},m.mixin=function(t){e(m.prototype,t)},m.prototype={_clickable:null,_draggable:null,_id:null,_group:null,_map:null,_marker:null,_popup:null,_position:null,getGroup:function(){return this._group},getId:function(){return this._id},getMap:function(){return this._map},getMarker:function(){return this._marker},getPopup:function(){return this._popup},getPosition:function(){return this._position},hasPopup:function(){return Boolean(this._popup)},isClickable:function(){return this._clickable},isDraggable:function(){return this._draggable},isPopupActive:function(){return Boolean(-1!==this._map.maptiks._popups.indexOf(this._popup))}},f.mixin=function(t){e(f.prototype,t)},f.prototype={_content:null,_map:null,_id:null,_marker:null,_popup:null,_position:null,getContent:function(){return this._content},getId:function(){return this._id},getMap:function(){return this._map},getMarker:function(){return this._marker},getMarkerIcon:function(){return Boolean(this._marker&&this._marker.maptiks)?this._marker.maptiks._icon:null},getPopup:function(){return this._popup},getPosition:function(){return this._position},hasMarker:function(){return Boolean(this._marker)}};var P=window.mapboxgl,S=P.Map,T=window.maptiks,E=null;P.Style.prototype.addLayer=function(){var t=P.Style.prototype.addLayer;return function(){t.apply(this,arguments),this.fire("addLayer",{sourceCache:this.sourceCaches[arguments[0].id]})}}(),P.Style.prototype.removeLayer=function(){var t=P.Style.prototype.removeLayer;return function(){t.apply(this,arguments),this.fire("removeLayer",{sourceId:arguments[0]})}}(),P.Marker.prototype.addTo=function(){var t=P.Marker.prototype.addTo;return function(){t.apply(this,arguments),this._map.fire("addMarker",{marker:this})}}(),P.Marker.prototype.remove=function(){var t=P.Marker.prototype.remove;return function(){t.apply(this,arguments),this.fire("removeMarker")}}(),P.Marker.prototype.togglePopup=function(){var t=P.Marker.prototype.togglePopup;return function(){t.apply(this,arguments),this.fire("click")}}(),P.Popup.prototype.addTo=function(){var t=P.Popup.prototype.addTo;return function(){t.apply(this,arguments),this._map.fire("addPopup",{popup:this})}}(),P.Popup.prototype.remove=function(){var t=P.Popup.prototype.remove;return function(){t.apply(this,arguments),this.fire("removePopup")}}(),P.Map=function(e){e=e||{};var r=T.trackcode||e.maptiks_trackcode||null;r&&!e.maptiks_notrack&&(this.windowMaptiks=new t({id:e.maptiks_id||d(window.location.pathname+window.location.hash)+"/:"+e.container,library:"mapboxgl",map:this,session:i(),trackcode:r,debug:T.debug||e.maptiks_debug,test:T.test||e.maptiks_test,standalone:T.standalone||e.maptiks_standalone,getMapState:y}),E=this.windowMaptiks,c.mixin(E),p.mixin(E),E._layers=[],u.mixin(E),E._markers=[],l.mixin(E),E._popups=[]),S.apply(this,arguments),E&&(void 0===this.getZoom()?this.once("load",g,E):g())},function(t,e){function r(){}r.prototype=e.prototype,t.superClass_=e.prototype,t.prototype=new r,t.prototype.constructor=t}(P.Map,S)});